[
  {
    "id": "1",
    "title": "字符串硬编码导致存储不一致",
    "description": "`content.js` 使用 `'pending_auto_comment'` 存储评论数据\n`commentAutomation.js` 使用 `'pending_auto_comment'` 读取\n`background.js` 调度器使用 `pending_auto_comment`（没有引号区分）\n由于字符串硬编码，一次修改遗漏了某个文件，导致数据存取失败",
    "rootCause": "**字符串硬编码**: 关键常量散落在多个文件中\n**无单一真相来源**: 没有中央常量定义",
    "prevention": "✅ 创建 `gemini-extension/core/constants.js`\n✅ 所有 Storage Key 使用 `EXT_CONSTANTS.STORAGE.xxx`\n✅ 所有 Message Action 使用 `EXT_CONSTANTS.ACTIONS.xxx`",
    "keywords": [
      "storage",
      "constant",
      "encoding"
    ]
  },
  {
    "id": "2",
    "title": "遗留代码与新模块冲突",
    "description": "`content.js` 中存在旧版 `AUTO-COMMENT RECOVERY` 代码块\n新版 `commentAutomation.js` 模块也有相同功能\n旧代码先读取并清除 Storage，导致新模块找不到数据",
    "rootCause": "**代码未彻底清理**: 添加新功能时未禁用旧逻辑\n**重复功能**: 相同功能存在于多个位置",
    "prevention": "✅ 添加新模块前，搜索项目中是否有相同功能\n✅ 旧代码用 `/* DISABLED V7.x */` 注释包裹，而非删除\n✅ 在 manifest.json 中明确模块加载顺序",
    "keywords": [
      "storage",
      "module"
    ]
  },
  {
    "id": "3",
    "title": "PowerShell 编码破坏中文/Emoji",
    "description": "使用 PowerShell 命令（如 `Set-Content`, `Out-File`）修改含中文字符的文件\n文件编码被改为 UTF-16 或 Windows-1252\n中文变成乱码，Emoji 丢失",
    "rootCause": "",
    "prevention": "✅ **绝对禁止**: 使用 PowerShell 修改含中文/Emoji 的 JS 文件\n✅ 使用 Python 脚本时必须指定 `encoding='utf-8'`\n✅ 使用工具的原生 `replace_file_content` 函数",
    "keywords": [
      "storage",
      "encoding"
    ]
  },
  {
    "id": "4",
    "title": "竞态条件 - Store 后 Tab 打开太快",
    "description": "调用 `chrome.storage.local.set()` 后立即 `chrome.tabs.create()`\n`set()` 是异步的，标签页打开时存储可能未完成\n新标签页的 content script 读取不到数据",
    "rootCause": "",
    "prevention": "✅ 所有 Tab 打开操作必须在 `set()` 的 callback 中执行\n✅ 增加小延迟 (100-500ms) 确保存储同步",
    "keywords": [
      "storage",
      "race"
    ]
  },
  {
    "id": "5",
    "title": "Service Worker 处理大文件挂起",
    "description": "`background.js` 的 `downloadVideo` 处理器逐字节转换 Base64\n对于大视频文件 (>30MB), 循环过长导致 Service Worker 超时",
    "rootCause": "",
    "prevention": "✅ 使用分块处理 (`chunkSize = 8192`)\n✅ 使用 `String.fromCharCode.apply()` 替代逐字节拼接",
    "keywords": [
      "timeout"
    ]
  },
  {
    "id": "6",
    "title": "修改 A 却破坏了 B",
    "description": "修改 `content.js` 中的评论逻辑时，意外影响了 GeminiGen 上传逻辑\n原因是共用了相同的消息监听器或存储逻辑",
    "rootCause": "",
    "prevention": "✅ **Pre-flight Checklist**: 修改前明确\"黄金功能\"\n✅ **影响分析**: 显式说明是否涉及共有逻辑\n✅ **端到端验证**: 测试完整流程，不仅仅是被修改的功能\n✅ **快照恢复**: 重大修改前执行 `/create_snapshot`",
    "keywords": [
      "storage",
      "message"
    ]
  },
  {
    "id": "7",
    "title": "遇到问题先查快照，不要盲目调试",
    "description": "Ask Studio 功能出现 \"Input box not found\" 错误\n没有第一时间查看快照中的参考代码\n盲目尝试各种修复（增加等待时间、更换选择器等）\n实际上快照中已有正确的实现逻辑",
    "rootCause": "**违反了准则 #3**: 没有优先使用快照作为参考\n**调试前没有做对比分析**: 应该先对比当前代码与快照的差异\n**忽略了已验证的工作流程**: 快照代表\"已知正确\"的状态",
    "prevention": "✅ **遇到问题的第一步**: 查看最近的快照文件\n✅ **对比差异**: 使用 `diff` 或手动对比当前代码与快照\n✅ **理解快照逻辑**: 先理解快照中为什么这样写\n✅ **渐进式修改**: 从快照逻辑开始，逐步适配到新架构",
    "keywords": [
      "snapshot",
      "check",
      "ask studio"
    ]
  },
  {
    "id": "8",
    "title": "模块化重构时必须验证完整消息链",
    "description": "",
    "rootCause": "**模块化过于激进**: 将 2000+ 行精简到 93 行，丢失了关键功能\n**消息链验证不完整**: 只验证了桥接层，未验证端到端流程\n**缺少功能清单**: 重构前未明确列出\"必须保留\"的功能",
    "prevention": "",
    "keywords": [
      "message",
      "module",
      "check"
    ]
  },
  {
    "id": "9",
    "title": "系统审核必须检查数据字段完整性，而非仅消息类型",
    "description": "",
    "rootCause": "| 审核项 | 做了 | 遗漏 |\n|--------|------|------|\n| 消息类型是否匹配 | ✅ | - |\n| 监听器是否存在 | ✅ | - |\n| **消息字段是否完整** | ❌ | 遗漏 |\n| **端到端数据追踪** | ❌ | 遗漏 |\n| **功能使用的数据来源是否正确** | ❌ | 遗漏 |",
    "prevention": "",
    "keywords": [
      "message",
      "check"
    ]
  },
  {
    "id": "10",
    "title": "深度审核必须包含代码执行与 TODO 扫描",
    "description": "",
    "rootCause": "**过度依赖静态观察**: 仅通过文件名和代码结构判断功能是否存在，没有实际运行脚本验证。\n**忽略 TODO 标记**: 未对项目进行全局 `grep \"TODO\"` 扫描，导致假性完成。\n**类型诊断不彻底**: 虽然注意到了有类型错误，但未深入分析这些错误是否会阻断核心业务逻辑。",
    "prevention": "",
    "keywords": [
      "check"
    ]
  },
  {
    "id": "11",
    "title": "代码编辑导致结构破坏 (Early Return)",
    "description": "在 `youtube-analytics.js` 中，一个 `return false;` 被错误放置在 `try/catch` 块后，导致后续的 `scrapeAnalyticsData` 函数声明不可达。这直接导致了数据采集功能失效。",
    "rootCause": "**编辑失误**: 在合并或修改代码时，未注意函数闭合位置。\n**缺乏语法检查**: 修改后未运行 `node --check` 验证结构。",
    "prevention": "✅ **强制语法检查**: 每次修改 JS 文件后，必须运行 `node --check file.js`。\n✅ **关注函数边界**: 修改长文件时，特别注意 `}` 的位置。\n✅ **验证不可达代码**: 使用 IDE 或工具检查是否有 Unreachable code。",
    "keywords": [
      "check",
      "syntax",
      "structure"
    ]
  },
  {
    "id": "12",
    "title": "消息链审计必须从发送端出发",
    "description": "在审计消息链时，仅从 `background.js` 的现有处理器出发，检查是否有匹配的消息类型。这导致遗漏了 4 个关键的缺失处理器（`relayGeminiVideoResult`, `relayYouTubeUploadComplete`, `relayCommentPosted`, `xPostResult`）。",
    "rootCause": "**审计方向错误**: 从接收端（处理器）出发，只能验证已存在的处理器是否正确，无法发现缺失的处理器。\n**搜索不完整**: 没有系统地扫描所有 `chrome.runtime.sendMessage` 调用。",
    "prevention": "✅ **从发送端出发**: 先扫描所有 `sendMessage` 调用，提取 action 名称。\n✅ **反向验证**: 检查 `background.js` 是否有对应的处理器。\n✅ **使用自动化工具**: 运行 `node scripts/message-chain-auditor.js` 进行自动检测。\n✅ **集成到 pipeline**: 已将消息链检查添加为 `pipeline-verify.js` 的 Step 6。",
    "keywords": [
      "message",
      "audit",
      "handler",
      "sendMessage"
    ]
  }
]